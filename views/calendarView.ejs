<script>
  const tasks = [];

  fetch('/api/tasks')
    .then(response => response.json())
    .then(data => {
      tasks.splice(0, tasks.length);
      data.forEach(task => tasks.push(task));
      renderCalendar(selectedYear, selectedMonth);
    });

  const monthNames = ["January", "February", "March", "April", "May", "June",
                      "July", "August", "September", "October", "November", "December"];

  let currentDate = new Date();
  let selectedYear = currentDate.getFullYear();
  let selectedMonth = currentDate.getMonth();

  const monthYearEl = document.getElementById('monthYear');
  const calendarGrid = document.getElementById('calendarGrid');
  const taskDropdown = document.getElementById('taskDropdown');
  const taskList = document.getElementById('taskList');
  const selectedDateEl = document.getElementById('selectedDate');

  function renderCalendar(year, month) {
    calendarGrid.innerHTML = '';
    monthYearEl.textContent = monthNames[month] + " " + year;

    const firstDay = new Date(year, month, 1).getDay();
    const lastDate = new Date(year, month + 1, 0).getDate();

    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement('div');
      calendarGrid.appendChild(emptyCell);
    }

    for (let day = 1; day <= lastDate; day++) {
      const dayCell = document.createElement('div');
      dayCell.textContent = day;

      const today = new Date();
      if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
        dayCell.classList.add('today');
      }

      dayCell.addEventListener('click', function() {
        showTasksForDate(year, month, day);
      });

      calendarGrid.appendChild(dayCell);
    }
  }

  function showTasksForDate(year, month, day) {
    const monthStr = String(month + 1).padStart(2,'0');
    const dayStr = String(day).padStart(2,'0');
    const dateStr = year + "-" + monthStr + "-" + dayStr;
    const tasksForDate = tasks.filter(function(task) { return task.due === dateStr; });

    selectedDateEl.textContent = "Tasks for " + dateStr;
    taskList.innerHTML = '';

    if (tasksForDate.length === 0) {
      taskList.innerHTML = '<li>No tasks for this date</li>';
    } else {
      tasksForDate.forEach(function(task) {
        const li = document.createElement('li');
        li.textContent = task.name;
        const priority = document.createElement('span');
        priority.classList.add('priority');
        priority.textContent = " (" + task.priority + ")";
        li.appendChild(priority);
        taskList.appendChild(li);
      });
    }

    taskDropdown.style.display = 'block';
    taskDropdown.scrollIntoView({behavior:'smooth'});
  }

  document.getElementById('prevMonth').addEventListener('click', function() {
    selectedMonth--;
    if (selectedMonth < 0) {
      selectedMonth = 11;
      selectedYear--;
    }
    renderCalendar(selectedYear, selectedMonth);
  });

  document.getElementById('nextMonth').addEventListener('click', function() {
    selectedMonth++;
    if (selectedMonth > 11) {
      selectedMonth = 0;
      selectedYear++;
    }
    renderCalendar(selectedYear, selectedMonth);
  });

  renderCalendar(selectedYear, selectedMonth);
</script>
